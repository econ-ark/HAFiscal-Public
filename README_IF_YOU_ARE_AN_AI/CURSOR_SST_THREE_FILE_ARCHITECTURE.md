# Three-File SST Architecture for Cursor Indexing

**Created**: 2025-11-01  
**Status**: âœ… Implemented and Tested  
**Pattern**: Single Source of Truth (SST) with Clear Separation of Concerns

## Overview

The HAFiscal project uses a **three-file SST architecture** for managing file exclusions across Git and Cursor AI:

```
ðŸ“„ .gitignore                      â†’ Master: Git exclusions (494 lines)
ðŸ“„ .cursorindexingignore.additions â†’ Master: Cursor-only exclusions (179 lines)
ðŸ“„ .cursorindexingignore           â†’ Generated: Combined result (391 lines)
```

## Architecture Principles

### 1. Single Source of Truth (SST)

Each exclusion pattern has **exactly one authoritative source**:

| Pattern Type | Master Source | Auto-Generated |
|--------------|---------------|----------------|
| Git exclusions | `.gitignore` | `.cursorindexingignore` |
| Cursor-only exclusions | `.cursorindexingignore.additions` | `.cursorindexingignore` |
| Combined exclusions | N/A | `.cursorindexingignore` |

### 2. Separation of Concerns

Each file has a **single, clear responsibility**:

**`.gitignore`** (Git SST)
- **Responsibility**: Define files excluded from Git commits
- **Edited by**: Developers (manual maintenance)
- **Used by**: Git version control

**`.cursorindexingignore.additions`** (Cursor-only SST)
- **Responsibility**: Define files excluded from Cursor indexing but OK in Git
- **Edited by**: Developers (manual maintenance)
- **Used by**: Generation script

**`.cursorindexingignore`** (Generated artifact)
- **Responsibility**: Provide combined exclusions to Cursor
- **Edited by**: Generation script (automatic)
- **Used by**: Cursor AI indexing engine

### 3. No Duplication, No Drift

- âœ… Patterns appear in **exactly one master file**
- âœ… Changes to master files automatically propagate
- âœ… Generation takes < 1 second
- âœ… Can be automated in pre-commit hooks or CI

## File Contents

### `.gitignore` (494 lines, 22KB)

**Purpose**: Git exclusions (traditional .gitignore content)

**Contains**:
- LaTeX auxiliary files (`*.aux`, `*.log`, `*.fls`)
- Emacs temporary files (`*~`, `#*#`)
- macOS system files (`.DS_Store`, `._*`)
- Python cache (`__pycache__/`, `*.pyc`)
- Virtual environments (`venv/`, `.venv/`)
- Build artifacts (`dist/`, `.eggs/`)

**Example patterns**:
```gitignore
*.aux
*.log
__pycache__/
.venv/
*.pyc
```

**Editing**:
```bash
# Normal Git workflow - edit as usual
vim .gitignore
git add .gitignore
git commit -m "Ignore new build artifacts"

# Then regenerate Cursor exclusions
make cursor-indexing-ignore
```

### `.cursorindexingignore.additions` (179 lines, 6.7KB)

**Purpose**: Cursor-specific exclusions (files in Git but shouldn't be indexed)

**Contains**:
- Binary images (`*.png`, `*.jpg`, `*.svg`) - 267 files
- Generated PDFs (`*.pdf`, `Figures/`, `Tables/`) - 302 files  
- Private directories (`*_private/`, `Private/`) - 130MB
- Historical content (`history/`, `Highlighted/`) - 27 files
- LaTeX packages (`@local/texlive/`) - 5.8MB
- Backup venv (`.venv.backup-py39/`) - 755MB

**Example patterns**:
```gitignore
# Binary images (committed for docs but not searchable)
*.png
*.jpg
*.svg

# Generated PDFs (committed for distribution)
*.pdf
Figures/
Tables/

# Private content (committed but privacy-sensitive)
*_private/
Private/
```

**Editing**:
```bash
# Add Cursor-specific exclusions
vim .cursorindexingignore.additions
git add .cursorindexingignore.additions
git commit -m "Exclude large binary assets from Cursor"

# Regenerate combined file
make cursor-indexing-ignore
```

### `.cursorindexingignore` (391 lines, GENERATED)

**Purpose**: Combined exclusions used by Cursor

**Header**:
```gitignore
# ============================================================================
# Cursor AI Indexing Exclusions for HAFiscal Project
# ============================================================================
# AUTOGENERATED - DO NOT EDIT DIRECTLY
# Generated by: @resources/scripts/generate-cursorindexingignore.sh
#
# Single Source of Truth (SST) Three-File Architecture:
# 1. .gitignore                      â†’ Master for Git exclusions
# 2. .cursorindexingignore.additions â†’ Master for Cursor-only exclusions
# 3. .cursorindexingignore           â†’ GENERATED (this file)
#
# To regenerate: make cursor-indexing-ignore
# ============================================================================
```

**Structure**:
```
[Header with generation info]

# SECTION 1: Patterns from .gitignore
[All non-comment patterns from .gitignore]

# SECTION 2: Cursor-Specific Additional Exclusions
[All non-comment patterns from .cursorindexingignore.additions]

[Footer with pattern count and timestamp]
```

**DO NOT EDIT**: This file is regenerated automatically. Any manual edits will be overwritten.

## Usage

### Decision Tree: Where to Add Patterns

```
â”Œâ”€ Should this file be in Git? â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                           â”‚
â”‚  NO: Exclude from Git commits                            â”‚
â”‚  â”œâ”€ Add to: .gitignore                                   â”‚
â”‚  â”œâ”€ Run: make cursor-indexing-ignore                     â”‚
â”‚  â””â”€ Result: Excluded from both Git and Cursor            â”‚
â”‚                                                           â”‚
â”‚  YES: Keep in Git but don't index                        â”‚
â”‚  â”œâ”€ Add to: .cursorindexingignore.additions              â”‚
â”‚  â”œâ”€ Run: make cursor-indexing-ignore                     â”‚
â”‚  â””â”€ Result: In Git, excluded from Cursor only            â”‚
â”‚                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Common Workflows

#### Workflow 1: Exclude New Build Artifacts (Git + Cursor)

```bash
# Edit .gitignore
echo "*.build" >> .gitignore

# Regenerate Cursor exclusions
make cursor-indexing-ignore

# Commit both files
git add .gitignore .cursorindexingignore
git commit -m "Exclude .build files"
```

#### Workflow 2: Exclude Large Binary Assets (Cursor Only)

```bash
# Edit .cursorindexingignore.additions
echo "*.zip" >> .cursorindexingignore.additions

# Regenerate combined file
make cursor-indexing-ignore

# Commit both files
git add .cursorindexingignore.additions .cursorindexingignore
git commit -m "Exclude zip archives from Cursor indexing"

# Reload Cursor
# Cmd+Shift+P â†’ "Developer: Reload Window"
```

#### Workflow 3: Manual Regeneration

```bash
# After editing either master file
make cursor-indexing-ignore

# Or directly
@resources/scripts/generate-cursorindexingignore.sh

# Preview without writing
@resources/scripts/generate-cursorindexingignore.sh --dry-run
```

## Generation Script

**Location**: `@resources/scripts/generate-cursorindexingignore.sh`

**Algorithm**:
```bash
1. Validate .gitignore exists
2. Validate .cursorindexingignore.additions exists
3. Generate header with metadata
4. Extract non-comment patterns from .gitignore â†’ SECTION 1
5. Extract non-comment patterns from .additions â†’ SECTION 2
6. Add footer with pattern count and timestamp
7. Write to .cursorindexingignore
```

**Invocation**:
```bash
# Via Makefile (recommended)
make cursor-indexing-ignore

# Direct execution
@resources/scripts/generate-cursorindexingignore.sh

# Dry-run (preview)
@resources/scripts/generate-cursorindexingignore.sh --dry-run

# Dry-run to file
@resources/scripts/generate-cursorindexingignore.sh --dry-run > preview.txt
```

**Output**:
```
âœ… Generated: /path/to/.cursorindexingignore
   Total lines: 391
   Patterns: 341

   Sources:
     - .gitignore: 494 lines
     - .cursorindexingignore.additions: 179 lines

Next steps:
  1. Review: cat .cursorindexingignore | head -50
  2. Reload Cursor: Cmd+Shift+P â†’ 'Developer: Reload Window'
  3. Test: Cmd+P â†’ type 'HAFiscal.pdf' (should NOT appear)
  4. Test: Cmd+P â†’ type 'reproduce.sh' (SHOULD appear)
```

## Statistics

### File Sizes
```
.gitignore                         494 lines   22 KB   (manual)
.cursorindexingignore.additions    179 lines    7 KB   (manual)
.cursorindexingignore              391 lines   18 KB   (generated)
```

### Pattern Counts
```
Total patterns: 341
  - From .gitignore: ~220 patterns
  - From .additions: ~121 patterns
```

### Files Excluded
```
Virtual environments:  22,122 files (1.6GB)   [from .gitignore]
Private content:          279 files (130MB)   [from .additions]
Binary images:            267 files           [from .additions]
Generated PDFs:           302 files           [from .additions]
LaTeX packages:            43 packages (5.8MB) [from .additions]
```

### Files Indexed (After Exclusions)
```
Source code (.py/.sh/.tex/.md):  ~477 files  âœ…
Configuration (.json/.yml):       ~24 files  âœ…
Documentation (.md/.txt):        ~179 files  âœ…
Total indexed:                   ~680 files  âœ…
```

## Testing

### Test 1: Verify No Patterns Lost

```bash
# Before regeneration
OLD_COUNT=$(grep -v '^#' .cursorindexingignore | grep -v '^$' | wc -l)

# Regenerate
make cursor-indexing-ignore

# After regeneration
NEW_COUNT=$(grep -v '^#' .cursorindexingignore | grep -v '^$' | wc -l)

# Verify
if [ $NEW_COUNT -ge $OLD_COUNT ]; then
  echo "âœ… No patterns lost (old: $OLD_COUNT, new: $NEW_COUNT)"
else
  echo "âŒ Patterns lost! (old: $OLD_COUNT, new: $NEW_COUNT)"
fi
```

### Test 2: Verify Cursor Excludes PDFs

```bash
# In Cursor: Cmd+P â†’ type "HAFiscal.pdf"
# Expected: Should NOT appear (or very low priority)

# In Cursor chat: @HAFiscal.pdf
# Expected: Should work (not indexed but accessible)
```

### Test 3: Verify Source Files Indexed

```bash
# In Cursor: Cmd+P â†’ type "reproduce.sh"
# Expected: Should appear normally

# In Cursor: Cmd+P â†’ type "HAFiscal.tex"
# Expected: Should appear normally
```

## Automation

### Option 1: Pre-Commit Hook (Recommended)

**Purpose**: Auto-regenerate when `.gitignore` or `.additions` change

**Implementation**:
```bash
# .git/hooks/pre-commit
#!/bin/bash

if git diff --cached --name-only | grep -qE '^\.gitignore$|^\.cursorindexingignore\.additions$'; then
    echo "Regenerating .cursorindexingignore..."
    make cursor-indexing-ignore
    git add .cursorindexingignore
    echo "âœ… .cursorindexingignore updated"
fi
```

### Option 2: CI/CD Validation

**Purpose**: Ensure generated file is up to date in CI

**Implementation**:
```yaml
# .github/workflows/lint.yml
- name: Check cursor indexing ignore is up to date
  run: |
    make cursor-indexing-ignore
    if ! git diff --exit-code .cursorindexingignore; then
      echo "ERROR: .cursorindexingignore out of sync"
      echo "Run: make cursor-indexing-ignore"
      exit 1
    fi
```

### Option 3: Git Alias

**Purpose**: Convenient command for regeneration

**Implementation**:
```bash
# Add to ~/.gitconfig or .git/config
[alias]
    regen-cursor = "!make cursor-indexing-ignore"

# Usage
git regen-cursor
```

## Troubleshooting

### Issue: Patterns Not Taking Effect

**Symptoms**: Files still appearing in Cursor search despite being in `.cursorindexingignore`

**Solutions**:
1. Force Cursor re-index: `Cmd+Shift+P` â†’ "Developer: Reload Window"
2. Verify generation: `make cursor-indexing-ignore`
3. Check pattern syntax: Ensure patterns match file paths

### Issue: Missing Patterns After Regeneration

**Symptoms**: Pattern count decreased after regeneration

**Cause**: Pattern may have been manually added to `.cursorindexingignore` (wrong!)

**Solution**:
```bash
# Add to correct master file
echo "missing-pattern" >> .cursorindexingignore.additions

# Regenerate
make cursor-indexing-ignore
```

### Issue: Generation Script Fails

**Symptoms**: `ERROR: .cursorindexingignore.additions not found`

**Solution**:
```bash
# Create the additions file if missing
touch .cursorindexingignore.additions

# Or restore from this documentation
# (See ".cursorindexingignore.additions" section above)
```

## Comparison: Two-File vs Three-File Architecture

### Two-File (Previous Approach)

```
.gitignore
.cursorindexingignore  [manually maintained, duplicates .gitignore patterns]
```

**Problems**:
- âŒ Duplication: ~220 patterns duplicated between files
- âŒ Drift: Changes to .gitignore not reflected in .cursorindexingignore
- âŒ Maintenance: Must update both files for Git exclusions
- âŒ Confusion: Which file to edit?

### Three-File (Current Approach)

```
.gitignore                      [master: Git exclusions]
.cursorindexingignore.additions [master: Cursor-only exclusions]
.cursorindexingignore          [generated: combination]
```

**Benefits**:
- âœ… No duplication: Each pattern has one master source
- âœ… No drift: Automatic propagation via generation
- âœ… Easy maintenance: Update master files, run `make`
- âœ… Clear ownership: Obvious where each pattern belongs

## Related Documentation

- **Implementation**: `@resources/scripts/generate-cursorindexingignore.sh`
- **Usage**: `Makefile` â†’ `cursor-indexing-ignore` target
- **Strategy**: `README_IF_YOU_ARE_AN_AI/CURSOR_INDEXING_STRATEGY.md`
- **Analysis**: `CURSOR_INDEXING_ANALYSIS.md`
- **SST Overview**: `README_IF_YOU_ARE_AN_AI/CURSOR_SST_IGNORE_STRATEGY.md`

## Summary

### Architecture
```
ðŸ“„ .gitignore (494 lines)
   â†“
   â†“ [Generation Script]
   â†“ combines with
   â†“
ðŸ“„ .cursorindexingignore.additions (179 lines)
   â†“
   â†“ [Generation Script]
   â†“ produces
   â†“
ðŸ“„ .cursorindexingignore (391 lines, 341 patterns)
```

### Key Commands
```bash
# Regenerate combined file
make cursor-indexing-ignore

# Add Git exclusion
echo "*.build" >> .gitignore && make cursor-indexing-ignore

# Add Cursor-only exclusion
echo "*.zip" >> .cursorindexingignore.additions && make cursor-indexing-ignore

# Preview generation
@resources/scripts/generate-cursorindexingignore.sh --dry-run
```

### Success Metrics
- âœ… 0 patterns lost during generation
- âœ… 341 patterns total (220 Git + 121 Cursor-only)
- âœ… Clear separation of concerns
- âœ… True SST pattern with no duplication
- âœ… < 1 second generation time

---

**Last Updated**: 2025-11-01  
**Status**: âœ… Implemented, tested, and documented  
**Pattern**: Three-File SST Architecture  
**Philosophy**: Single Source of Truth, Separation of Concerns, DRY (Don't Repeat Yourself)

